# コードのためのテスト
**テストとはバグを見つけることではない**
## テストについて考える
テストについて考えるということは、処理コードを記述する前の段階で、様々な発見をすることができる。

例えばデータベースに対してあるサイトを10時間以上視聴している人のリストをクエリー(データベースに対する要求)を実行して返すという場合。

```python
def return_avid_viewers() do
#どうしようか
end
```
この場合先にテストについて考えると、まずテストのためにデータベースを渡す必要があるとなると`db`をメソッドに引き渡すことになる。

その次にデータベースのスキーマ(構造)に着目すると「オープンした動画ファイル」と「視聴を終えた動画ファイル」のフィールドが存在し、どれを使えばいいのかをテストデータを設計するうえで決めなければならない。

この場合は「フィールドの名前を引き渡しておく」という対処が適切かもしれない。そうすれば手持ちのデータでテストができ、後々の変更も容易になる。

```python
def return_avid_users(db,qualifying_field_name) do
```
テストについて考えることで、変更する二つの事柄を考えることができた。

## テスト駆動コーディング
以上の例ではコーディングより先にテストケースを考えることで、まず初めにユーザー視点に立って外部からメソッドを客観的にとらえられるようになった。

**テストはコードのユーザー第一号である**

### テスト駆動開発(TDD)の概要
先にテストそのものを書き上げるといいのではないかという考え方
方法は、
1. 追加したいごく一部の機能を決める
2. 機能が実装されたときにパスするテストを記述する
3. すべてのテストを実行し、すべて失敗することを確認する
4. テストがパスするだけの最低限のコードを記述し、正しく実行されることを検証
5. コードの修正を行う

### TDDのリスク
- 100%の達成率を目指して法外な時間をテストに費やす
- 冗長なテストコードを用意しがちになる
- 目的地が見えないまま開発を進めがちになる。

**テストの達成度に執着するな**
## テストしやすいコード
ICやハードウェアは、たいてい
- 自己診断機構(簡単な状態の診断ができる)
- 検査用アクセス機構を備えている。

といった特徴を持つ。我々も初期の段階からソフトウェア中にテスト機構を組み込んでおき、ソフトウェアを接続する前にテストできるようにするべきである。

## ユニットテスト
- モジュールごとに独立した形でふるまいを検証する
  - 現実世界での感触が見えてくる
ユニットテストはモジュールのテストを実行するコードになる。
## 契約に対するテスト
我々はコードにおいて契約がきちんと守られているのかを確認するためのテストケースを記述する必要がある。

具体的には
- コードが契約に合致するか
- 契約の意味が自分たちが考えている通りのものなのか
を考える必要がある。

例えば平方根を計算する以下の契約を持ったプログラムを考える
```
pre-conditions:
    argument >= 0;

post-conditions:
    ((result * result) - argument).abs <= epsilon * argument
```
以上の契約は、
- 負の引数を渡すと拒絶される
- 0を引数として渡すと受理される
- 0から引数が表現できる最大値までの値を渡すと結果の2乗と元の引数の差は計算機イプシロンより小さくなる

ということを表している。すると以下のようなテストスクリプトを考えることができる。

```Java
assertWithinEpsilon(my_sqrt(),)
assertWithinEpsilon(my_sqrt(0),0)
assertWithinEpsilon(mysqat(2,0),1.4142135624)
assertWithinEpsilon(my_sqrt(64.0),8.0)
assertWithinEpsilon(my_sqrt(1.0e7),3162.2776602)
assertRaiseException fn => my_sqrt(-4,0) end
```
**<font color = red>テスト設計を行う</font>**

## テスト文化
テストの計画は徹底的に練る必要がある。このとき考えられる選択肢は、
- 最初にテスト
- 開発中にテスト
- テストをしない
の三つであるが、TDDは最初にテストをするという点で最も優れたやり方といえる。

テストというものは**常にパスする**という必要がある。常に失敗するテストを放置するということはそれすなわち**割れた窓を放置する**ということになるのである。

また**テストコードは本番と同じくらい慎重に扱う必要がある**。誤った前提を置くということはテストは脆弱なものとなる。

それによってソフトウェア全体の脆弱性も上がる。

**<font color = red>ソフトウェアをテストすること。でなれればユーザーにテストを強いることになる。</font>**

